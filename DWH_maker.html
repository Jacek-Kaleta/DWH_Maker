<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="DWH_maker.css"> 
	<title>DATAWARE HOUSE SQL QUERY CREATOR</title>
</head>
<body>
	<script src="tabjs.js"></script>
	
	<label for="file-input" class="custom-file-upload">Load Definition / Project / Fields</label> 
	<input class="inp" id="file-input" type="file"/>
	<button class="btn" onclick="createSQL()">Create SQL</button>
	<button class="btn" onclick="saveState()">Save Project</button>
	<input class="inp" type="text" id="fields" placeholder="Paste fields" size="20" onpaste="pasted(this)">
	
	<a href="https://github.com/Jacek-Kaleta/DWH_Maker" target="_blank">
	on GitHub
	</a>
	<!--
	<input class="inp" type="text" id="searchInput" placeholder="Text to search" size="20">
	<button class="btn" onclick="search()">Search</button>
	-->
	<div id="sqltree"></div>
	
	<script>
		const fileInput = document.getElementById('file-input');
		
		var htmlDocument = document.documentElement;

		var altkey = false;
		var ctrlkey = false;
		let fields =  undefined ;
		function handleKeyDown(event) {
			if (event.key == "Alt")altkey = true;
			if (event.key == "Control")ctrlkey = true;
			if (event.key == "-") collapseAll();
		}

		function handleKeyUp(event) {
			if (event.key =="Alt")altkey = false;
			if (event.key == "Control")ctrlkey = false;
		}

		htmlDocument.addEventListener("keydown", handleKeyDown);
		htmlDocument.addEventListener("keyup", handleKeyUp);

		fileInput.addEventListener('change', function(event) 
		{
			const selectedFile = event.target.files[0];
			loadFile(selectedFile);
		});
		
		function collapseAll()
		{
			const elem = document.querySelectorAll('span');
			elem.forEach(function(e) 
			{
				if (e.classList.contains("tree-node")) 
				{
					var childUl = e.nextElementSibling;
					if (childUl) {
						childUl.classList.toggle("collapsed");
					}
				}
			})
		};
		
		/*function search() {
			var searchText = document.getElementById('searchInput').value;
			var elements = document.getElementsByTagName('*');
			for (var i = 0; i < elements.length; i++) {
				var element = elements[i];
				if (getDirectInnerText(element).includes(searchText.toUpperCase()) && searchText.trim().length >0) 
				{
					element.classList.add('highlight');
				} else 
				{
					element.classList.remove('highlight');
				}
			}
		}*/
		
		function getDirectInnerText(element) 
		{
			let childNodes = element.childNodes;
			result = '';

			for (var i = 0; i < childNodes.length; i++) 
			{
				if(childNodes[i].nodeType == 3) 
				{
					result += childNodes[i].data;
				}
			}
			return result;
		}

		function loadFile(file) {
			let reader = new FileReader();
			reader.onload = function(event) 
			{
				let fileContent = event.target.result;
				if (file.name.split('.').pop().toLowerCase() =='txt')
					loadTree(fileContent);
				else
				if (file.name.split('.').pop().toLowerCase() =='csv')
					loadFields(fileContent);
				else
				if (file.name.split('.').pop().toLowerCase() =='html')
					loadSession(fileContent);
			};
			reader.readAsText(file);
		}

		function loadSession(fileContent)
		{
			let treeContainer = document.getElementById("sqltree");
			treeContainer.innerHTML = fileContent;
			treeContainer.addEventListener("click", toggleCollapse);
			treeContainer.addEventListener("click", highlightSelected);
			setCheckBoxHandlers();
		}
		
		function loadTree(fileContent)
		{
			let json = tab2json(fileContent,{value:"name", subnodes:"children"});
			createTree(json);
		}

		function toggleCollapse(event) {
			var target = event.target;

			if (target.parentNode.classList.contains("tree-node")) 
			{
				var childUl = target.parentNode.nextElementSibling;
				if (childUl) {
					childUl.classList.toggle("collapsed");
				}
			}
		}

		function highlightSelected(event) {
			let target = event.target;
			if (target.classList.contains("tree-node")) {
			let selectedNodes = document.getElementsByClassName("selected");
			for (var i = 0; i < selectedNodes.length; i++) {
			  selectedNodes[i].classList.remove("selected");
			}
			target.classList.add("selected");
		  }
		}

		function poczNIECYFRY(tekst) {
		const wynik = tekst.match(/\d/);
		if (wynik) return tekst.substring(0, wynik.index)
		return undefined;
		}

		function createTree(json)
		{
			let treeContainer = document.getElementById("sqltree");
			let db = undefined ;
			
			function createTreeView(data, parentElement, dbname) 
			{
				var ul = document.createElement("ul");
				for (var i = 0; i < data.length; i++)
				if(data[i].name.length >0)
				{
					var li = document.createElement("li");
					var node = document.createElement("span");
					var db ;
					var checkbox = document.createElement("input");
					checkbox.type = "checkbox";

					node.classList.add("tree-node");
					
					if (data[i].name[0]!='!')
					{
						node.innerHTML = joinSpan(data[i].name);
						if (data[i].name.substring(0,3)=='-- ')
						{
							let name = data[i].name.substring(3).split(",")[0];
							if (data[i].name.substring(3).split(",")[1] != undefined)
							{
								db = data[i].name.substring(3).split(",")[1].trim();
								checkbox.dataset.db = db;
							}
							//checkbox.id= name ;
							checkbox.dataset.ident = name;
						} else
						{
							let name = data[i].name.split(".")[0];
							//checkbox.id= name ;
							checkbox.dataset.name = name;
							if (data[i].name.split(".").length == 2)
								checkbox.dataset.field = dbname+"."+data[i].name.split(".")[1].replace(",","");
						}
						checkbox.dataset.line = data[i].name ;
						li.appendChild(checkbox);
						li.appendChild(node);
					}
					else
					{
						node.innerHTML = joinSpan(data[i].name.substring(1));
						li.appendChild(node);
					}
					ul.appendChild(li);
					if (data[i].children != undefined)
					if (data[i].children.length > 0) {
					  li.appendChild(createTreeView(data[i].children, li, db));
					}
				}

				parentElement.appendChild(ul);
				return ul;

				function polaczZeSpanem(ciagZnakow) 
				{
					return  ciagZnakow.split('.').map(
						function(element, n) 
						{
							return '<span class="c'+n+'">' + polaczSpacjeZeSpanem(element) + '</span>';
						}).join('.');
				}
				
				function polaczSpacjeZeSpanem(ciagZnakow) 
				{
					return  ciagZnakow.split(' ').map(
						function(element, n) 
						{
							return '<span class="s'+n+'">' + element + '</span>';
						}).join(' ');
				}
				
				function joinSpan(c)
				{
					let i = 0;
					let k = 0;
					let s = "";
					while (i< c.length)
					{
						while (i< c.length && (c[i]==' ' || c[i]=='.')) 
						{
							s+=c[i]; i++;
						}
						k++;
						s+='<span class="c'+k+'">' ;
						while (i< c.length && !(c[i]==' ' || c[i]=='.')) 
						{
							s+=c[i]; i++;
						}
						s+='</span>' ;
					}
					return s;
				}
			}

			treeContainer.innerHTML="";
			treeContainer.appendChild(createTreeView(json, treeContainer));
			treeContainer.addEventListener("click", toggleCollapse);
			treeContainer.addEventListener("click", highlightSelected);
			setCheckBoxHandlers();
		}
		
		function setCheckBoxHandlers()
		{
			const checkboxes = document.querySelectorAll('input[type="checkbox"]');
			checkboxes.forEach(function(checkbox) 
			{
				checkbox.addEventListener('change', function() 
				{
					const checkboxes = document.querySelectorAll('input[type="checkbox"]');
					if(this.dataset.name)
					if(!ctrlkey)
					{
						if (this.checked)
						{
							checkboxes.forEach(checkbox => {
								if (checkbox.dataset.ident == this.dataset.name)
								checkbox.checked = true; 
							});
						}
						else
						{
							checkboxes.forEach(checkbox => {
								if (checkbox.dataset.ident == this.dataset.name)
									checkbox.checked = false; 
							});
						} ;
					}
					
					if(this.dataset.ident)
					{
						if (this.checked)
						{
							checkboxes.forEach(checkbox => {
								if (checkbox.dataset.ident == this.dataset.ident)
								checkbox.checked = true; 
							});
						}
						else
						{
							checkboxes.forEach(checkbox => {
								if (checkbox.dataset.ident == this.dataset.ident)
									checkbox.checked = false; 
							});
							checkboxes.forEach(checkbox => {
								if (checkbox.dataset.name == this.dataset.ident)
									checkbox.checked = false; 
							});
						} ;
					}
					
					if (altkey)
					{
						const mstr = poczNIECYFRY(checkbox.dataset.line);
						if (mstr != undefined)
						{
							checkboxes.forEach(checkbox => {
								if (poczNIECYFRY(checkbox.dataset.line) == mstr)
								checkbox.checked = true; 
							});
						}
						checkboxes.forEach(checkbox => {
							if (checkbox.dataset.ident == this.dataset.name)
								checkbox.checked = true; 
						});
					} ;
						
					if (ctrlkey)
					{
						const mstr = poczNIECYFRY(checkbox.dataset.line);
						if (mstr != undefined)
						{
							checkboxes.forEach(checkbox => {
								if (poczNIECYFRY(checkbox.dataset.line) == mstr)
								checkbox.checked = false; 
							});
						}
					};
				})
			});
		}
		
		
		function pasted(element) {
			setTimeout(function(){
			selectFields(element.value);
			}, 0);
		}

		function loadFields(fileContent)
		{
			selectFields(fileContent.replace(/\r/g,'').replace(/\n/g," "));
		}

		function selectFields(value)
		{
			const paste = document.getElementById('fields');
			fields = value.replace(/\t/g, '.')
			fields = '#'+fields.replace(/ /g, '#')+'#';
			let fn = fields.length ;

			const checkboxes = document.querySelectorAll('input[type="checkbox"]');
			let aliases =[]; 
			checkboxes.forEach(function(checkbox) 
			{
				checkbox.checked = false ;
			});
			let n = 0;
			let found =  undefined ;
			checkboxes.forEach(function(checkbox) 
			{
				if (checkbox.dataset.field != undefined)
				{
					if (fields.indexOf('#'+checkbox.dataset.field+'#')>=0)
					{
						fields = fields.replace('#'+checkbox.dataset.field+'#','#');
						checkbox.checked = true ;
						if (found==undefined) found =checkbox.dataset.field;
						else found+="\r\n"+checkbox.dataset.field;
						n++;
						if (aliases.indexOf(checkbox.dataset.name) <0)
						{
							aliases.push(checkbox.dataset.name);
						}
					}
				}
			})
			
			console.log('Found:');
			console.log(found);
			console.log('');
			fields= fields.replace(/#/g,"\r\n");
			fields = fields.replace(/\r\n+$/, '');
			if (fields.length >0)
			{
				console.log('Not Found:');
				console.log('');
				fields= fields.split("\r\n");
			} fields = [];
			
			aliases.forEach(function(value) 
			{
				checkboxes.forEach(checkbox => {
				if (checkbox.dataset.ident == value)
						checkbox.checked = true; 
				});
			});
			
			paste.value="("+fn+','+n+','+fields.length+')';
		}

		function createSQL()
		{
			let e = document.getElementById('sqltree');
			let sqltext ="" ;
			
			processUL(e.querySelector('UL').childNodes,'');
			
			function processUL(nodes, t)
			{
				for(let i=0;i<nodes.length;i++)
				{
					if (nodes[i].childNodes.length >= 2)
					{
						if (nodes[i].childNodes[0].tagName =='INPUT')
						{
							if (nodes[i].childNodes[0].checked === true )
							{
								sqltext += t+nodes[i].childNodes[1].innerText+"\r\n";
								if (nodes[i].childNodes.length == 3)
									if (nodes[i].childNodes[2].tagName == 'UL')
										processUL(nodes[i].childNodes[2].childNodes, t+'\t');
							}
						}
						else
						{
							sqltext += t+nodes[i].childNodes[0].innerText+"\r\n";
							if (nodes[i].childNodes.length == 2)
								if (nodes[i].childNodes[1].tagName == 'UL')
									processUL(nodes[i].childNodes[1].childNodes, t+'\t');
						}
					}
					else
						sqltext += t+nodes[i].childNodes[0].innerText+"\r\n";
				}
			}
			
			saveSQLToFile(sqltext);
			return sqltext ;
			
			function saveSQLToFile(text) 
			{
				let file = new Blob([text], { type: 'text/plain' });
				{
					let a = document.createElement('a');
					a.href = URL.createObjectURL(file);
					a.download = 'query.sql';
					a.click();
				}
			}
		}
	
		function saveState()
		{
			function saveInitState()
			{
				const element = document.getElementById("sqltree");
				if (element) 
				{
					const inputElements = element.querySelectorAll('input');
					inputElements.forEach((inputElement) => 
					{
						let str = '<input type="checkbox"';
						if (inputElement.id != undefined ) str +=' id="'+inputElement.id+'"';
						if (inputElement.checked ) str +=' checked="true"';
						
						if (inputElement.dataset.db != undefined)
							str+=' data-db="'+inputElement.dataset.db+'"';
						if (inputElement.dataset.name != undefined)
							str+=' data-name="'+inputElement.dataset.name+'"';
						if (inputElement.dataset.field != undefined)
							str+=' data-field="'+inputElement.dataset.field+'"';
						if (inputElement.dataset.ident != undefined)
							str+=' data-ident="'+inputElement.dataset.ident+'"';
						if (inputElement.dataset.line != undefined)
							str+=' data-line="'+inputElement.dataset.line+'"';
						str+='>' ;
						inputElement.outerHTML = str;
					});
					saveToFile(element.innerHTML);
				}
			
			
				function saveToFile(text) 
				{
					let file = new Blob([text], { type: 'text/plain' });
					{
						let a = document.createElement('a');
						a.href = URL.createObjectURL(file);
						a.download = 'state.html';
						a.click();
					}
				}
			}
			saveInitState();
			setCheckBoxHandlers();
		}
	</script>
</body>
</html>
